{% extends "base.html" %}
{% block title %}Manage Orders - Digicam Shop{% endblock %}

{% block css %}
<style>
    .admin-header {
        background: linear-gradient(135deg, var(--teal), var(--burnt-orange));
        color: white;
        padding: 40px 0;
        margin: -30px -15px 30px -15px;
        border-radius: 0 0 20px 20px;
    }
    .admin-header h3 {
        color: white;
        font-size: 2.5rem;
        margin: 0;
    }
    .admin-container {
        background-color: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header text-center">
    <div class="container">
        <h3>ðŸ›’ Manage Orders</h3>
        <p class="mt-2">Review and process customer orders</p>
    </div>
</div>

<div class="container">
<div class="admin-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 style="color: var(--teal);">All Orders</h4>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#searchModal">
            Search
        </button>
    </div>
<div class="table-responsive">
<table class="table table-bordered align-middle">
  <thead class="table-dark">
    <tr>
      <th width="80">Order #</th>
      <th>Customer</th>
      <th>Payment Method</th>
      <th>Status</th>
      <th>Decline Reason</th>
      <th width="220">Actions</th>
    </tr>
  </thead>

  <tbody>
    {% for o in orders %}
    <tr
      class="{% if o.status == 'Declined' %}table-danger
             {% elif o.status == 'Approved' %}table-success
             {% endif %}"
    >
      <td><strong>#{{ o.id }}</strong></td>
      <td>{{ o.customer_name }}</td>
      <td>{{ o.payment_method }}</td>

    <td>
  <span class="badge
    {% if o.status == 'Pending' %}bg-warning text-dark
    {% elif o.status == 'Approved' %}bg-success
    {% elif o.status == 'Shipped' %}bg-primary
    {% elif o.status == 'Delivered' %}bg-success
    {% elif o.status == 'Declined' %}bg-danger
    {% endif %}">
    {{ o.status }}
  </span>
</td>

      <td>
        {% if o.status == 'Declined' %}
          {{ o.decline_reason }}
        {% else %}
          <span class="text-muted">â€”</span>
        {% endif %}
      </td>

<td>
  <form method="POST" action="{{ url_for('update_order', id=o.id) }}" class="d-inline">
    <select name="status" class="form-select d-inline w-100" onchange="this.form.submit()">
      <option value="" selected disabled>Action</option>

      {% if o.status == 'Pending' %}
        <option value="Approved">Approve</option>
      {% elif o.status == 'Approved' %}
        <option value="Shipped">Shipped</option>
      {% elif o.status == 'Shipped' %}
        <option value="Delivered">Delivered</option>
      {% endif %}
    </select>
  </form>
  <div>
  {% if o.status in ['Pending', 'Approved'] %}
    <button type="button" class="btn btn-sm btn-danger w-100" data-bs-toggle="modal" data-bs-target="#declineModal{{ o.id }}">
      Decline
    </button>
  {% endif %}
  </div>
</td>


    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

{% if not orders %}
<div class="alert alert-info text-center">
  <h5>No orders found.</h5>
  <p class="mb-0">Orders will appear here when customers make purchases.</p>
</div>
{% endif %}

<!-- ================= MODALS (OUTSIDE TABLE) ================= -->
{% for o in orders %}
<div class="modal fade" id="declineModal{{ o.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="POST"
          action="{{ url_for('decline_order', id=o.id) }}"
          class="modal-content">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          Decline Order #{{ o.id }}
        </h5>
        <button type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <label class="form-label fw-bold">
          Reason for declining this order
        </label>

        <textarea name="reason"
                  class="form-control"
                  rows="4"
                  placeholder="Example: Payment proof is invalid or unreadable."
                  required></textarea>

        <div class="form-text text-muted">
          This reason will be visible to the customer.
        </div>
      </div>

      <div class="modal-footer">
        <button type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal">
          Cancel
        </button>

        <button type="submit"
                class="btn btn-danger">
          Confirm Decline
        </button>
      </div>

    </form>
  </div>
</div>
{% endfor %}
</div>
</div>

<!-- Search & Filter Modal -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="searchModalLabel">
                    Search & Filter Orders
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="GET" action="{{ url_for('admin_orders') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>Search</strong></label>
                        <input type="text" name="search" class="form-control" placeholder="Search by customer name or order ID..." value="{{ search_query or '' }}">
                        <small class="text-muted">Search orders by customer name or order number</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Status</strong></label>
                        <select name="status" class="form-control">
                            <option value="">All Statuses</option>
                            <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
                            <option value="Approved" {% if status_filter == 'Approved' %}selected{% endif %}>Approved</option>
                            <option value="Declined" {% if status_filter == 'Declined' %}selected{% endif %}>Declined</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="{{ url_for('admin_orders') }}" class="btn btn-secondary">Clear Filters</a>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>
</div>
{% endblock %}
